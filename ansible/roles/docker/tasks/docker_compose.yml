- name: Récupérer les infos passwd de {{ docker_user }}
  getent:
    database: passwd
    key: "{{ docker_user }}"
  register: passwd_info

- name: Définir le home de l'utilisateur Docker
  set_fact:
    docker_user_home: "{{ passwd_info.ansible_facts.getent_passwd[docker_user][4] }}"

- name: Créer dossier des plugins Docker
  file:
    path: "{{ docker_user_home }}/.docker/cli-plugins"
    state: directory
    mode: '0755'
    owner: "{{ docker_user }}"
    group: "{{ docker_user }}"

- name: Start Docker Compose
  stat:
    path: "{{ docker_user_home }}/.docker/cli-plugins/docker-compose"
  register: docker_compose_bin

- name: Télécharger Docker Compose
  get_url:
    url: "https://github.com/docker/compose/releases/download/{{ compose_version }}/docker-compose-linux-x86_64"
    dest: "{{ docker_user_home }}/.docker/cli-plugins/docker-compose"
    mode: '0755'
    owner: "{{ docker_user }}"
    group: "{{ docker_user }}"
    timeout: 30
  when: not docker_compose_bin.stat.exists
  retries: 3
  delay: 5
  register: compose_download
  until: compose_download is succeeded

- name: Télécharger le fichier de checksum
  get_url:
    url: "https://github.com/docker/compose/releases/download/{{ compose_version }}/docker-compose-linux-x86_64.sha256"
    dest: "/tmp/docker-compose.sha256"
    mode: '0644'
    timeout: 30
  register: sha_file
  retries: 3
  delay: 5
  until: sha_file is succeeded

- name: Vérifier le hash SHA256
  shell: |
    echo "$(cut -d' ' -f1 /tmp/docker-compose.sha256)  {{ docker_user_home }}/.docker/cli-plugins/docker-compose" > /tmp/docker-compose-verify.sha256
    sha256sum --check /tmp/docker-compose-verify.sha256
  register: sha_verify
  failed_when: "'OK' not in sha_verify.stdout"
  changed_when: false
  when: sha_file is changed

- name: Nettoyer les fichiers temporaires de checksum
  file:
    path: "/tmp/docker-compose{{ item }}"
    state: absent
  loop:
    - .sha256
    - -verify.sha256

- name: Vérifier que docker compose fonctionne
  become: true
  become_user: "{{ docker_user }}"
  shell: "{{ docker_user_home }}/.docker/cli-plugins/docker-compose version"
  register: compose_version_check
  changed_when: false
